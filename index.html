<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LYNN v5.3 - Quotation System</title>
    
    <!-- ฟอนต์ภาษาไทย (Sarabun) -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <!-- Library สำหรับแปลง HTML เป็น PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        /* ===============================
           1. CSS & UI Design (Based on v5.2)
           =============================== */
        :root {
            --primary-red: #C00000;
            --bg-white: #FFFFFF;
            --text-dark: #333333;
            --border-grey: #E0E0E0;
            --bg-grey: #F8F9FA;
        }

        body {
            font-family: 'Sarabun', sans-serif;
            background-color: var(--bg-white);
            color: var(--text-dark);
            margin: 0;
            padding: 0;
            line-height: 1.5;
            -webkit-tap-highlight-color: transparent;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* Page Transitions */
        .page {
            display: none;
            animation: fadeIn 0.3s ease-out;
            padding-bottom: 50px;
        }
        .active { display: block; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Headlines */
        h1 { color: var(--primary-red); font-size: 28px; text-align: center; margin: 10px 0; font-weight: 700; }
        h2 { font-size: 20px; border-left: 5px solid var(--primary-red); padding-left: 12px; margin: 20px 0 15px 0; color: var(--text-dark); }
        .label { font-weight: 600; font-size: 14px; color: #555; margin-top: 15px; display: block; }

        /* Inputs */
        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            margin-top: 5px;
            border: 1px solid var(--border-grey);
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
            background-color: #FAFAFA;
            font-family: 'Sarabun', sans-serif;
            transition: all 0.2s;
        }
        input:focus, select:focus {
            outline: none;
            border-color: var(--primary-red);
            background-color: #fff;
            box-shadow: 0 0 0 3px rgba(192, 0, 0, 0.1);
        }

        /* Buttons */
        .btn {
            display: block;
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            text-align: center;
        }
        .btn-primary { background-color: var(--primary-red); color: white; box-shadow: 0 4px 10px rgba(192, 0, 0, 0.2); }
        .btn-primary:active { transform: scale(0.98); }
        .btn-secondary { background-color: white; color: #555; border: 1px solid #ccc; }
        .btn-danger { background-color: #fff; color: #d32f2f; border: 1px solid #ffcdd2; width: auto; padding: 8px 12px; font-size: 14px; display: inline-block; margin-top: 0; }

        /* Item Cards */
        .item-card {
            background-color: var(--bg-grey);
            border-radius: 12px;
            padding: 18px;
            margin-bottom: 20px;
            border: 1px solid #eee;
            position: relative;
        }
        .item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #e0e0e0; padding-bottom: 10px; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }

        /* Live Summary Box (Page 3) */
        .summary-box {
            background: #fff;
            border: 1px solid var(--primary-red);
            border-radius: 10px;
            padding: 20px;
            margin-top: 30px;
        }
        .sum-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 15px; }
        .sum-total { font-size: 22px; font-weight: bold; color: var(--primary-red); border-top: 2px solid #eee; padding-top: 10px; margin-top: 10px; }

        /* PDF Printable Area (A4 Simulation) */
        #printable-wrapper {
            background: #525659; /* Gray background behind paper */
            padding: 20px;
            overflow-x: auto;
            border-radius: 8px;
        }
        #printable-area {
            background: white;
            width: 750px; /* Fixed width for PDF generation consistency */
            min-height: 1000px;
            margin: 0 auto;
            padding: 40px;
            box-sizing: border-box;
            position: relative;
            /* Important for html2pdf */
        }

        /* PDF Table Styles */
        .pdf-table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; }
        .pdf-table th { background-color: #f2f2f2; font-weight: bold; border: 1px solid #ddd; padding: 10px; text-align: center; }
        .pdf-table td { border: 1px solid #ddd; padding: 10px; vertical-align: top; }
        .text-right { text-align: right; }
        .text-center { text-align: center; }
        
        /* Helper classes for PDF page breaks */
        .no-break { page-break-inside: avoid; }
        tr { page-break-inside: avoid; }

        /* Loading Overlay */
        #loading {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9); z-index: 999;
            display: none; flex-direction: column; justify-content: center; align-items: center;
        }
        .spinner {
            border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-red);
            border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

<!-- Loading -->
<div id="loading">
    <div class="spinner"></div>
    <p style="margin-top:10px; font-weight:600; color:var(--primary-red);">กำลังสร้างไฟล์ PDF...</p>
</div>

<div class="container">

    <!-- Page 1: Welcome -->
    <div id="page-1" class="page active">
        <div style="text-align: center; margin-top: 30vh;">
            <h1 style="font-size: 40px; margin-bottom: 5px;">LYNN</h1>
            <p style="color: #666; font-size: 18px;">คำนวณราคาประตู-หน้าต่าง</p>
            <div style="width: 60px; height: 4px; background: var(--primary-red); margin: 20px auto;"></div>
            <button class="btn btn-primary" onclick="goToPage(2)">สร้างใบเสนอราคาใหม่</button>
        </div>
    </div>

    <!-- Page 2: Customer Info -->
    <div id="page-2" class="page">
        <h1>LYNN</h1>
        <h2>ข้อมูลลูกค้าและเซลล์</h2>
        
        <label class="label">ชื่อลูกค้า / เจ้าของบ้าน *</label>
        <input type="text" id="inp-cust-name" placeholder="ระบุชื่อลูกค้า">

        <label class="label">ที่ตั้งงาน / โครงการ</label>
        <textarea id="inp-cust-addr" rows="3" placeholder="ระบุที่อยู่หน้างาน"></textarea>

        <label class="label">เบอร์โทรลูกค้า</label>
        <input type="tel" id="inp-cust-phone" placeholder="08x-xxx-xxxx">

        <hr style="margin: 25px 0; border: 0; border-top: 1px dashed #ccc;">

        <label class="label">ชื่อเซลล์ผู้ดูแล *</label>
        <input type="text" id="inp-sale-name" placeholder="ระบุชื่อเซลล์">

        <label class="label">เบอร์โทรเซลล์</label>
        <input type="tel" id="inp-sale-phone" placeholder="08x-xxx-xxxx">

        <button class="btn btn-primary" onclick="validatePage2()">ถัดไป: เพิ่มรายการสินค้า</button>
        <button class="btn btn-secondary" onclick="goToPage(1)">ย้อนกลับ</button>
    </div>

    <!-- Page 3: Add Items -->
    <div id="page-3" class="page">
        <h1>รายการสินค้า</h1>
        
        <div id="items-wrapper"></div>

        <button class="btn btn-secondary" style="border: 2px dashed var(--primary-red); color: var(--primary-red);" onclick="addItem()">
            + เพิ่มบานใหม่
        </button>

        <div class="summary-box">
            <div class="sum-row"><span>ยอดรวมก่อนส่วนลด:</span> <span id="live-subtotal">0.00</span></div>
            
            <label class="label" style="margin-top:10px;">ส่วนลดท้ายบิล (บาท)</label>
            <input type="number" id="inp-discount" value="0" placeholder="0" oninput="calculateTotal()" style="font-weight:bold; color:var(--primary-red);">
            
            <div class="sum-row" style="margin-top:10px;"><span>ยอดหลังหักส่วนลด:</span> <span id="live-after-disc">0.00</span></div>
            <div class="sum-row"><span>VAT 7%:</span> <span id="live-vat">0.00</span></div>
            <div class="sum-total"><span>ยอดสุทธิ:</span> <span id="live-grand">0.00</span></div>
        </div>

        <button class="btn btn-primary" onclick="validatePage3()">ถัดไป: สรุปรายละเอียด</button>
        <button class="btn btn-secondary" onclick="goToPage(2)">ย้อนกลับ</button>
    </div>

    <!-- Page 4: Summary & PDF -->
    <div id="page-4" class="page">
        <h2 style="margin-top:0;">ตัวอย่างใบเสนอราคา</h2>
        <p style="font-size:14px; color:#666; margin-bottom:10px;">ตรวจสอบความถูกต้องก่อนบันทึก</p>

        <!-- Area for PDF Generation -->
        <div id="printable-wrapper">
            <div id="printable-area">
                <!-- Header -->
                <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                    <div>
                        <h1 style="margin:0; text-align:left; font-size:36px;">LYNN</h1>
                        <p style="margin:0; font-size:14px; color:#666;">ใบเสนอราคา (Quotation)</p>
                    </div>
                    <div style="text-align:right;">
                        <div style="font-size:14px;"><strong>วันที่:</strong> <span id="pdf-date">-</span></div>
                    </div>
                </div>

                <hr style="border:1px solid #eee; margin:20px 0;">

                <!-- Info Grid -->
                <div class="grid-2 no-break" style="font-size:14px; margin-bottom:20px;">
                    <div style="background:#f9f9f9; padding:15px; border-radius:8px;">
                        <strong style="color:var(--primary-red);">ลูกค้า</strong><br>
                        <span id="pdf-cust-name">-</span><br>
                        <span id="pdf-cust-addr" style="font-size:13px; color:#555;">-</span><br>
                        โทร: <span id="pdf-cust-phone">-</span>
                    </div>
                    <div style="background:#f9f9f9; padding:15px; border-radius:8px;">
                        <strong style="color:var(--primary-red);">ผู้เสนอราคา</strong><br>
                        <span id="pdf-sale-name">-</span><br>
                        โทร: <span id="pdf-sale-phone">-</span>
                    </div>
                </div>

                <!-- Table -->
                <table class="pdf-table">
                    <thead>
                        <tr>
                            <th style="width:5%">#</th>
                            <th style="width:40%">รายการ</th>
                            <th style="width:20%">ขนาด (มม.)</th>
                            <th style="width:10%">จำนวน</th>
                            <th style="width:25%" class="text-right">รวม (บาท)</th>
                        </tr>
                    </thead>
                    <tbody id="pdf-table-body">
                        <!-- Rows rendered by JS -->
                    </tbody>
                </table>

                <!-- Footer Summary -->
                <div class="no-break" style="margin-top:20px; display:flex; justify-content:flex-end;">
                    <div style="width:250px;">
                        <div class="sum-row"><span>รวมเป็นเงิน</span> <span id="pdf-subtotal">0.00</span></div>
                        <div class="sum-row"><span>ส่วนลด</span> <span id="pdf-discount">0.00</span></div>
                        <div class="sum-row" style="border-bottom:1px solid #ddd; padding-bottom:5px;"><span>หลังหักส่วนลด</span> <span id="pdf-after-disc">0.00</span></div>
                        <div class="sum-row" style="margin-top:5px;"><span>VAT 7%</span> <span id="pdf-vat">0.00</span></div>
                        <div class="sum-row total" style="font-weight:bold; color:var(--primary-red); font-size:18px; margin-top:10px;">
                            <span>ยอดสุทธิ</span> <span id="pdf-grand">0.00</span>
                        </div>
                    </div>
                </div>

                <!-- Footer Note -->
                <div class="no-break" style="margin-top:40px; font-size:12px; color:#999; text-align:center; border-top:1px solid #eee; padding-top:10px;">
                    เอกสารนี้สร้างโดยระบบอัตโนมัติของ LYNN Application<br>
                    ราคานี้ยังไม่รวมค่าติดตั้งและค่าขนส่ง (เว้นแต่ระบุไว้)
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div style="margin-top:20px;">
            <button class="btn btn-primary" onclick="generatePDF()">บันทึกเป็น PDF (ดาวน์โหลด)</button>
            <button class="btn btn-secondary" onclick="goToPage(3)">แก้ไขรายการ</button>
            <button class="btn btn-danger" style="width:100%; margin-top:15px;" onclick="if(confirm('ข้อมูลทั้งหมดจะถูกล้าง เริ่มใหม่?')) location.reload()">เริ่มใบเสนอราคาใหม่</button>
        </div>
    </div>

</div>

<script>
    /* ===============================
       2. Data Configuration (v5.3 Logic)
       =============================== */
    const DATA = {
        products: ["ประตู(DOOR)", "หน้าต่าง(WINDOW)", "ช่องแสง"],
        styles: ["บานเลื่อนสลับ", "บานเปิด", "บานกระทุ้ง"],
        models: ["Pro(OK SERIES)", "Premium(XPLUS)", "Platinum(PRIME)", "Prestige(GRANDPANO)"],
        colors: ["ขาวพาวเดอร์โค้ท", "ดำพาวเดอร์โค้ท", "เทาพาวเดอร์โค้ท"],
        glass: ["ใส", "เขียวใสตัดแสงประหยัดพลังงาน", "นิรภัย"]
    };

    let items = []; // Store items here

    // --- Pricing Engine (สูตรคำนวณตามโจทย์) ---
    function getBasePricePerSqm(model, type, glass) {
        // Model: Pro
        if (model.includes("Pro")) {
            if (type.includes("หน้าต่าง")) {
                if (glass === "ใส") return 3000;
                if (glass.includes("เขียว")) return 3300;
                if (glass === "นิรภัย") return 3900;
            }
            if (type.includes("ประตู")) {
                if (glass === "ใส") return 3400;
                if (glass.includes("เขียว")) return 3700;
                if (glass === "นิรภัย") return 4400;
            }
        }
        // Model: Premium
        else if (model.includes("Premium")) {
            if (type.includes("หน้าต่าง")) {
                if (glass === "ใส") return 3500;
                if (glass.includes("เขียว")) return 3900;
                if (glass === "นิรภัย") return 4800;
            }
            if (type.includes("ประตู")) {
                if (glass === "ใส") return 4000;
                if (glass.includes("เขียว")) return 4900;
                if (glass === "นิรภัย") return 5500;
            }
        }
        // Model: Platinum
        else if (model.includes("Platinum")) {
            if (type.includes("หน้าต่าง")) {
                if (glass === "ใส") return 4500;
                if (glass.includes("เขียว")) return 4900;
                if (glass === "นิรภัย") return 5800;
            }
            if (type.includes("ประตู")) {
                if (glass === "ใส") return 5000;
                if (glass.includes("เขียว")) return 5900;
                if (glass === "นิรภัย") return 6800;
            }
        }
        // Model: Prestige
        else if (model.includes("Prestige")) {
            if (type.includes("หน้าต่าง")) {
                if (glass === "ใส") return 5500;
                if (glass.includes("เขียว")) return 5900;
                if (glass === "นิรภัย") return 6600;
            }
            if (type.includes("ประตู")) {
                if (glass === "ใส") return 6000;
                if (glass.includes("เขียว")) return 5900;
                if (glass === "นิรภัย") return 6800;
            }
        }
        
        return 0; // Default fallback if no match (e.g. ช่องแสง)
    }

    function getSurcharge(color) {
        // บวกเพิ่ม 200 หากเป็นสีดำหรือเทา
        if (color.includes("ดำ") || color.includes("เทา")) {
            return 200;
        }
        return 0;
    }

    /* ===============================
       3. Application Logic
       =============================== */
    
    // Navigation
    function goToPage(pageNum) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(`page-${pageNum}`).classList.add('active');
        window.scrollTo(0,0);
    }

    // Initialize
    window.onload = function() {
        addItem(); // Start with 1 item
    };

    // Validation
    function validatePage2() {
        const name = document.getElementById('inp-cust-name').value.trim();
        const sale = document.getElementById('inp-sale-name').value.trim();
        if(!name || !sale) { alert("กรุณากรอกชื่อลูกค้า และชื่อเซลล์"); return; }
        goToPage(3);
    }

    function validatePage3() {
        // Check inputs
        let valid = true;
        items.forEach(item => {
            const w = document.getElementById(`w-${item.id}`).value;
            const h = document.getElementById(`h-${item.id}`).value;
            if(!w || !h || w <= 0 || h <= 0) valid = false;
        });

        if(!valid) { alert("กรุณากรอกขนาด กว้าง x สูง ให้ครบทุกรายการ"); return; }
        
        renderSummaryPDF();
        goToPage(4);
    }

    // Helper: Create Dropdown Options
    const createOptions = (arr) => arr.map(v => `<option value="${v}">${v}</option>`).join('');

    // Item Management
    function addItem() {
        const id = Date.now(); // Unique ID
        items.push({ id: id });

        const div = document.createElement('div');
        div.className = 'item-card';
        div.id = `card-${id}`;
        div.innerHTML = `
            <div class="item-header">
                <span style="font-weight:bold; color:var(--text-dark);">รายการสินค้า</span>
                ${items.length > 1 ? `<button class="btn-danger" onclick="removeItem(${id})">ลบ</button>` : ''}
            </div>

            <div class="grid-2">
                <div>
                    <label class="label">ประเภท</label>
                    <select id="type-${id}" onchange="calcItem(${id})">${createOptions(DATA.products)}</select>
                </div>
                <div>
                    <label class="label">รูปแบบ</label>
                    <select id="style-${id}">${createOptions(DATA.styles)}</select>
                </div>
            </div>

            <label class="label">รุ่นสินค้า (Model)</label>
            <select id="model-${id}" onchange="calcItem(${id})">${createOptions(DATA.models)}</select>

            <label class="label">สีสินค้า (Color)</label>
            <select id="color-${id}" onchange="calcItem(${id})">${createOptions(DATA.colors)}</select>

            <label class="label">ประเภทกระจก</label>
            <select id="glass-${id}" onchange="calcItem(${id})">${createOptions(DATA.glass)}</select>

            <div class="grid-2">
                <div>
                    <label class="label">กว้าง (มม.)</label>
                    <input type="number" id="w-${id}" placeholder="0" oninput="calcItem(${id})">
                </div>
                <div>
                    <label class="label">สูง (มม.)</label>
                    <input type="number" id="h-${id}" placeholder="0" oninput="calcItem(${id})">
                </div>
            </div>

            <label class="label">จำนวน (บาน)</label>
            <input type="number" id="qty-${id}" value="1" min="1" oninput="calcItem(${id})">

            <div style="background:#fff; padding:10px; margin-top:10px; border-radius:6px; border:1px dashed #ccc; font-size:14px;">
                <div class="sum-row"><span>พื้นที่ต่อบาน:</span> <span id="disp-area-${id}">0.00 ตร.ม.</span></div>
                <div class="sum-row"><span>ราคาตั้งต้น/ตร.ม.:</span> <span id="disp-base-${id}">0</span></div>
                <div class="sum-row"><span>บวกเพิ่มค่าสี:</span> <span id="disp-sur-${id}" style="color:var(--primary-red);">0</span></div>
                <div class="sum-row" style="font-weight:bold; border-top:1px solid #eee; padding-top:5px;">
                    <span>รวมรายการนี้:</span> <span id="disp-total-${id}">0.00</span>
                </div>
            </div>
        `;
        document.getElementById('items-wrapper').appendChild(div);
        calcItem(id); // Initial calc
    }

    function removeItem(id) {
        items = items.filter(i => i.id !== id);
        document.getElementById(`card-${id}`).remove();
        calculateTotal();
    }

    // Calculation Logic
    function calcItem(id) {
        // Get Inputs
        const model = document.getElementById(`model-${id}`).value;
        const type = document.getElementById(`type-${id}`).value;
        const glass = document.getElementById(`glass-${id}`).value;
        const color = document.getElementById(`color-${id}`).value;
        
        let w = parseFloat(document.getElementById(`w-${id}`).value) || 0;
        let h = parseFloat(document.getElementById(`h-${id}`).value) || 0;
        let qty = parseFloat(document.getElementById(`qty-${id}`).value) || 0;
        
        // 1. Convert mm -> meter
        let w_m = w / 1000;
        let h_m = h / 1000;
        
        // 2. Area
        let area = w_m * h_m;
        
        // 3. Get Base Price
        let basePrice = getBasePricePerSqm(model, type, glass);
        
        // 4. Get Surcharge
        let surcharge = getSurcharge(color);
        
        // 5. Price per piece (Base + Surcharge) * Area
        // หมายเหตุ: สูตรคำนวณตามโจทย์ตีความว่า (ราคาต่อตรม + ค่าเพิ่ม) * พื้นที่
        let pricePerSqmTotal = basePrice + surcharge;
        let pricePerPiece = pricePerSqmTotal * area;
        
        // 6. Line Total
        let lineTotal = pricePerPiece * qty;

        // Display Item Details
        document.getElementById(`disp-area-${id}`).innerText = area.toFixed(2) + ' ตร.ม.';
        document.getElementById(`disp-base-${id}`).innerText = basePrice.toLocaleString();
        document.getElementById(`disp-sur-${id}`).innerText = (surcharge > 0) ? `+${surcharge}` : '0';
        document.getElementById(`disp-total-${id}`).innerText = fmt(lineTotal);

        // Store Logic Data
        const itemObj = items.find(i => i.id === id);
        itemObj.lineTotal = lineTotal;

        calculateTotal();
    }

    function calculateTotal() {
        // 1. Subtotal
        let subtotal = items.reduce((sum, i) => sum + (i.lineTotal || 0), 0);
        
        // 2. Discount
        let discount = parseFloat(document.getElementById('inp-discount').value) || 0;
        if (discount > subtotal) {
            discount = subtotal; // Cap discount
            // document.getElementById('inp-discount').value = subtotal; // Optional: Force input change
        }
        
        // 3. After Discount
        let afterDisc = subtotal - discount;
        
        // 4. VAT 7%
        let vat = afterDisc * 0.07;
        
        // 5. Grand Total
        let grand = afterDisc + vat;

        // Display Live Summary
        document.getElementById('live-subtotal').innerText = fmt(subtotal);
        document.getElementById('live-after-disc').innerText = fmt(afterDisc);
        document.getElementById('live-vat').innerText = fmt(vat);
        document.getElementById('live-grand').innerText = fmt(grand);

        return { subtotal, discount, afterDisc, vat, grand };
    }

    function fmt(n) {
        return n.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    /* ===============================
       4. PDF Generation (Page 4)
       =============================== */
    function renderSummaryPDF() {
        // Render Header Info
        document.getElementById('pdf-cust-name').innerText = document.getElementById('inp-cust-name').value;
        document.getElementById('pdf-cust-addr').innerText = document.getElementById('inp-cust-addr').value;
        document.getElementById('pdf-cust-phone').innerText = document.getElementById('inp-cust-phone').value || '-';
        document.getElementById('pdf-sale-name').innerText = document.getElementById('inp-sale-name').value;
        document.getElementById('pdf-sale-phone').innerText = document.getElementById('inp-sale-phone').value || '-';
        
        const d = new Date();
        document.getElementById('pdf-date').innerText = `${d.getDate()}/${d.getMonth()+1}/${d.getFullYear()}`;

        // Render Table Rows
        const tbody = document.getElementById('pdf-table-body');
        tbody.innerHTML = '';
        
        items.forEach((item, index) => {
            const id = item.id;
            const model = document.getElementById(`model-${id}`).value;
            const type = document.getElementById(`type-${id}`).value;
            const style = document.getElementById(`style-${id}`).value;
            const color = document.getElementById(`color-${id}`).value;
            const glass = document.getElementById(`glass-${id}`).value;
            const w = document.getElementById(`w-${id}`).value;
            const h = document.getElementById(`h-${id}`).value;
            const qty = document.getElementById(`qty-${id}`).value;

            // Shorten Model Name for PDF to look cleaner
            let shortModel = model.split('(')[0]; 

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="text-center">${index + 1}</td>
                <td>
                    <strong>${model}</strong><br>
                    <small style="color:#555;">${type} - ${style}</small><br>
                    <small style="color:#555;">สี: ${color} | กระจก: ${glass}</small>
                </td>
                <td class="text-center">${w} x ${h}</td>
                <td class="text-center">${qty}</td>
                <td class="text-right">${fmt(item.lineTotal)}</td>
            `;
            tbody.appendChild(tr);
        });

        // Render Footer Numbers
        const t = calculateTotal();
        document.getElementById('pdf-subtotal').innerText = fmt(t.subtotal);
        document.getElementById('pdf-discount').innerText = fmt(t.discount);
        document.getElementById('pdf-after-disc').innerText = fmt(t.afterDisc);
        document.getElementById('pdf-vat').innerText = fmt(t.vat);
        document.getElementById('pdf-grand').innerText = fmt(t.grand);
    }

    function generatePDF() {
        // Show Loading
        document.getElementById('loading').style.display = 'flex';
        
        const element = document.getElementById('printable-area');
        const custName = document.getElementById('inp-cust-name').value || 'Customer';
        
        // Settings for html2pdf
        const opt = {
            margin:       [10, 10, 10, 10], // top, left, bottom, right (mm)
            filename:     `Quotation_${custName}.pdf`,
            image:        { type: 'jpeg', quality: 0.98 },
            html2canvas:  { scale: 2, useCORS: true, scrollY: 0 },
            jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' },
            pagebreak:    { mode: ['avoid-all', 'css', 'legacy'] }
        };

        // Execution
        html2pdf().set(opt).from(element).save()
        .then(() => {
            document.getElementById('loading').style.display = 'none';
        })
        .catch(err => {
            alert("เกิดข้อผิดพลาดในการสร้าง PDF");
            console.error(err);
            document.getElementById('loading').style.display = 'none';
        });
    }

</script>

</body>
</html>
